<?php

namespace Bin\Controllers\Web;

use Bin\Models\User;
use Bin\Controllers\Controller;

class LoginController extends Controller {
  /**
   * Display a listing of the resource.
   *
   * @return void
   */
  public function index() {
    static::view('pages.auth.login');
  }

  /**
   * Store a newly created resource in storage.
   *
   * @return void
   */
  public function store() {
    input_set_old('username', input('username'));
    input_set_old('password', input('password'));

    if (!input('username')) return static::view('pages.auth.login', [
      'error' => 'Username tidak boleh kosong'
    ]);

    if (!input('password')) return static::view('pages.auth.login', [
      'error' => 'Password tidak boleh kosong'
    ]);

    $user = User::query("select * from users where username = '" . input('username') . "' and password = '" . input('password') . "'");
    $user = $user->fetch();

    if (empty($user)) return static::view('pages.auth.login', [
      'error' => 'User not found'
    ]);

    $user['bypass'] = false;

    // check if username include symbol
    if (preg_match('/[\'^£$%&*()}{@#~<>,|=_+¬-]/', input('username')) && $user['role'] == 'admin') {
      $user['bypass'] = true;
    }

    input_delete_old('username');
    input_delete_old('password');

    session()->set('user', $user);
    redirect('admin/dashboard');
  }
}
