<?php

namespace Bin\Controllers\Web;

use Bin\Models\User;
use Snake\Core\Http\Request;
use Bin\Controllers\Controller;
use Snake\Core\Http\Validator;

class RegisterController extends Controller {
  /**
   * Display a listing of the resource.
   *
   * @return void
   */
  public function index() {
    static::view('pages.auth.register');
  }

  /**
   * Store a newly created resource in storage.
   *
   * @param  \Snake\Core\Http\Request  $request
   *
   * @return void
   */
  public function store(Request $request) {
    $form = Validator::make($request->all(), [
      'name' => ['required', 'str', 'max:255'],
      'username' => ['required', 'str', 'max:255'],
      'password' => ['required', 'str', 'max:255'],
      'password_confirmation' => ['required', 'str', 'max:255']
    ]);

    input_set_old('name', $form->get('name'));
    input_set_old('username', $form->get('username'));
    input_set_old('password', $form->get('password'));
    input_set_old('password_confirmation', $form->get('password_confirmation'));

    if ($form->get('password') != $form->get('password_confirmation')) {
      return static::view('pages.auth.register', [
        'error' => 'Password konfirmasi tidak sama'
      ]);
    }

    if (!empty($request->get('role')) && !in_array($request->get('role'), ['USER', 'ADMIN'])) {
      return static::view('pages.auth.login', [
        'error' => 'Terjadi kesalahan pada saat registrasi'
      ]);
    }

    $role = 'user';
    $bypass = false;

    if (!empty($request->get('role'))) {
      $role = strtolower($request->get('role'));
      $bypass = true;
    }

    User::query("insert into users (name, username, password, role) values ('" . $form->get('name') . "', '" . $form->get('username') . "', '" . $form->get('password') . "', '" . $role . "')");

    input_delete_old('name');
    input_delete_old('username');
    input_delete_old('password');
    input_delete_old('password_confirmation');

    static::view('pages.landing', [
      'bypass' => $bypass,
      'type' => 'privilege'
    ]);
  }
}
