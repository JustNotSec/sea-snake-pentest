<?php

namespace Bin\Controllers\Web;

use Bin\Models\User;
use Snake\Core\Http\Request;
use Bin\Controllers\Controller;

class ProfileController extends Controller {
  /**
   * Display a listing of the resource.
   *
   * @return void
   */
  public function index(Request $request, $error = null) {
    $user = $request->get('id');

    if ($error) return static::view('pages.profile.index', [
      'error' => $error
    ]);

    $data = User::query("select * from users where id = '" . $user . "'");
    $data = $data->fetch();

    if (empty($data)) return static::view('pages.profile.index', [
      'error' => 'User not found'
    ]);

    static::view('pages.profile.index', [
      'data' => $data
    ]);
  }

  /**
   * Update the specified resource in storage.
   *
   * @param  \Snake\Core\Http\Request  $request
   * @return void
   */
  public function update(Request $request) {
    $id = $request->get('id');

    // Get the input
    $name = input('name');
    $username = input('username');
    $password = input('password');

    if (empty($name) || empty($username)) {
      return static::view('pages.profile.index', [
        'error' => 'Name and username cannot be empty'
      ]);
    }

    $data = User::query("select * from users where id = '" . $id . "'");
    $data = $data->fetch();

    if (empty($data)) return static::view('pages.profile.index', [
      'error' => 'User not found'
    ]);

    $update = null;

    if (!empty($password)) {
      $update = User::query("update users set name = '" . $name . "', username = '" . $username . "', password = '" . $password . "' where id = '" . $id . "'");
    } else {
      $update = User::query("update users set name = '" . $name . "', username = '" . $username . "' where id = '" . $id . "'");
    }

    if (!$update) return $this->index($request, 'Failed to update user');

    $bypass = true;

    if (session()->exists('user')) {
      session()->regenerate();
      session()->set('user', [
        'id' => $id,
        'name' => $name,
        'username' => $username,
        'password' => $password ?? $data['password']
      ]);

      $bypass = false;
    }

    static::view('pages.landing', [
      'is_logged_in' => session()->exists('user'),
      'bypass' => $bypass,
      'type' => 'bac'
    ]);
  }
}
