<?= $this->extend('layouts.dashboard', ['title' => 'Pengguna']) ?>

<?= $this->append('css') ?>
  <link rel="stylesheet" href="<?= asset('css/dashboard-custom.css') ?>">
<?= $this->stop() ?>

<?= $this->section('sidebar') ?>
  <?php if (session()->exists('user') && session()->get('user')['role'] == 'admin'): ?>
    <?= $this->put('partials.sidebar.admin') ?>
  <?php else: ?>
    <?= $this->put('partials.sidebar.user') ?>
  <?php endif; ?>
<?= $this->stop() ?>

<?= $this->section('content') ?>
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="greet">Hello, <?= $get('username') ?></h1>
    <div>
      <a href="<?= route('admin.user.create') ?>" class="btn btn-primary">Tambah</a>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Pengguna</h5>
            <p class="card-text">Berikut adalah list pengguna.</p>
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Nama</th>
                  <th scope="col">Username</th>
                  <th scope="col">Role</th>
                  <th scope="col">Password</th>
                  <th scope="col">Aksi</th>
                </tr>
              </thead>
              <tbody>
                <?php if (is_null($get('users'))): ?>
                  <tr>
                    <td colspan="3" class="text-center">Data is empty</td>
                  </tr>
                <?php endif; ?>

                <?php if (!empty($get('users'))): ?>
                  <?php foreach ($get('users') as $key => $user): ?>
                    <tr>
                      <td><?= $user['name'] ?></td>
                      <td><?= $user['username'] ?></td>
                      <td><?= $user['role'] ?></td>
                      <td><?= $user['password'] ?></td>
                      <td>
                        <?php if ($user['username'] != $get('username')): ?>
                          <a href="<?= route('admin.user.edit') ?>?id=<?= $user['id'] ?>" class="btn btn-primary">Ubah</a>

                          <form action="<?= route('admin.user.index') ?>" method="get" class="d-inline">
                            <button type="submit" onclick="confirmDelete(<?= $user['id'] ?>)" class="btn btn-danger">Hapus</button>
                          </form>
                        <?php else: ?>
                          <button class="btn btn-primary" disabled="true">Ubah</button>
                          <button class="btn btn-danger" disabled="true">Hapus</button>
                        <?php endif; ?>
                      </td>
                    </tr>
                  <?php endforeach; ?>
                <?php endif; ?>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
<?= $this->stop() ?>

<?= $this->append('script') ?>
  <script>
    function confirmDelete(id) {
      const confirm = window.confirm('Apakah anda yakin ingin menghapus data ini?');

      if (confirm) {
        fetch(`<?= route('admin.user.delete') ?>?id=${id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
      }
    }
  </script>
<?= $this->stop() ?>
